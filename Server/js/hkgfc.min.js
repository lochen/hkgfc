var HKGCore=function(settings){this.xhr=null;this.server=1;this.url="http://forum1.hkgolden.com/topics.aspx?type=BW";this.channel="BW";this.channel_list={'ET':'娛樂台','CA':'時事台','FN':'財經台','gm':'遊戲台','HW':'硬件台','IN':'寬頻台','SW':'軟件台','MP':'手機台','SP':'體育台','LV':'感情台','SY':'講故台','ED':'飲食台','TR':'旅遊台','CO':'潮流台','AN':'動漫台','TO':'玩具台','MU':'音樂台','VI':'影視台','DC':'攝影台','ST':'學術台','TS':'汽車台','RA':'電　台','MB':'站務台','AC':'自組活動台','EP':'創意台','BW':'吹水台'};this.settings={sensor:0,server:'random',channel:'BW',timeout:60,storage:'cookie',cache:1};this.current={type:'topic'};this.t=0;$.extend(this.settings,settings);this.init(settings);}
HKGCore.prototype={init:function(data){var self=this;self.hash=window.location.hash;console.log('HKGCore.init()',data,self.hash);if(self.hash==''){self.topic(data);}else{$("#tab_loading").hide();var hashs=self.hash.split('-');self.view({id:hashs[1],title:hashs[2],page:1});}
$("#reload").click(function(){self.reload();});$("#tabs").find('li.active').click(function(){self.backTopic();});$("#switch_server").find('a').click(function(){self.server=$(this).attr('data-server');console.log('switch server',self.server);$("#current_server").html($(this).text());self.noty({text:'Switch server '+$(this).attr('data-server'),layout:self.settings.noty,type:'information',timeout:3000});});$("#channel_list").find('a').click(function(){self.channel=$(this).attr('data-type');self.setHeadTitle(self.channelName(self.channel+' - '+$("title").data('original')));console.log('switch channel',self.channel);$("#current_channel").html($(this).text());self.noty({text:'Switch channel '+$(this).text(),layout:self.settings.noty,type:'information',timeout:3000});if(self.xhr!=null)
self.xhr.abort();$("div.thread").hide();self.topic();});$(window).scroll(function(){if(self.current.type=='topic'){$("#bottom_toolbar").find('button.hide').hide();}else{$("#bottom_toolbar").find('button.hide').show();}
if($(window).scrollTop()>250){$("#bottom_toolbar").fadeIn('normal');}else{$("#bottom_toolbar").fadeOut('normal');}});$("#scroll_top").bind('click',function(){console.log('click scroll_top button');$(window).scrollTo(0,500);});$("#scroll_down").bind('click',function(){console.log('click scroll_down button');$(window).scrollTo($(document).height(),500);});$("#back_topic").bind('click',function(){self.backTopic();});$("#page_reload").bind('click',function(){self.reload();});$("#page_close").bind('click',function(){self.close();});$("#tabs_dropdown").contextmenu(function(){self.closeView('all');return false;});if(self.hash==''){$("title").data('original',$("title").text());$("title").html(self.channelName(self.settings.channel)+' - '+$("title").data('original'));}},topic:function(data){var self=this;var _data={server:self.settings.server,channel:self.channel,page:1}
$.extend(_data,data);if(_data.server=='random'){_data.server=self.randomServer();self.server=_data.server;}
self.current.type='topic';var _url=self.buildUrl(_data.server,'topics',_data.channel,_data.page);console.log('topic()',_data,_url);$("#current_server").html('Server '+_data.server);var len=$("#topic_table").find('tr:gt(1)').length;if(len!=0)
$("#topic_table").find('tr:gt(0)').fadeOut(300);self.keyboardControl();self.xhr=$.ajax({url:_url,timeout:(self.settings.timeout*1000),beforeSend:function(){$("#reload").attr('src','img/loading.gif');$("#tab_loading").show();$("#tab_topic").hide();},complete:function(){console.log('ajax complete');},success:function(response,status){$("#tab_loading").hide();$("#tab_topic").show();var html=removeScript(response);if($(html).find("a[href*='ProfilePage.aspx']").length!=0){console.log($(html).find("a[href*='ProfilePage.aspx']"));var user=$(html).find("a[href*='ProfilePage.aspx']");var username=$(user).html();var userid=$(user).attr('href').replace('ProfilePage.aspx?userid=','');$("#username").html(username);$("#login").html('Logout').attr('data-action','logout');console.log('is logined',username);self.noty({text:username+' is logged on server '+self.server});}else{$("#username").html('CD-ROM');$("#login").html('Login');}
var topic_div=$(html).find('div#HotTopics');if($(topic_div).length!=0){var list=[];$(topic_div).find('tr').each(function(i,rows){var cols=$(rows).find('td');var data={};if($($(cols).get(1)).text()!=""){var _total=1;var _topic=$(cols).get(1);if($($(cols).get(1)).find('a').length>1){_total=parseInt($($($(cols).get(1)).find('a').last()).text().replace(/\[\]/g,""));$(_topic).find('a').each(function(i,el){if(i!=0)
$(el).remove();});}
var _link=$(_topic).find('a').get(0);var m=$(_link).attr('href').match(/message\=([0-9]+)/);data.id=m[1];data.title=$.trim($(_topic).text().replace(/\[\]/g,"").replace("......",""));data.author=$.trim($($(cols).get(2)).text());var time_format=self.timeFormat($.trim($($(cols).get(3)).text()));data.time=time_format.time;data.timeago=time_format.timeago;data.replies=$.trim($($(cols).get(4)).text());data.score=$.trim($($(cols).get(5)).text());data.total_page=_total;list.push(data);}});if(list.length!=0){var j=0;$.each(list,function(i,data){var tr=$('<tr>').hide();if($.cookie('filter')){var filter=$.cookie('filter');$.each(filter,function(j,d){if(d.id==data.id){$(tr).addClass('blocked');}});}
var cls='unread';if(self.isread(data.id)){cls="read";}
var _cog='<a href="#" title="#'+(i+1)+'" class="btn btn-mini dropdown-toggle tcog" data-toggle="dropdown"><i class="icon-cog"></i></a><ul class="dropdown-menu dropdown-menu-cog"><li><a href="#" class="tcog-link" data-id="'+data.id+'"><i class="icon-share-alt"></i>LINK</a></li><li><a href="#" class="tcog-bookmark"><i class="icon-bookmark"></i>Bookmark</a></li><li><a href="#" class="tcog-filter"><i class="icon-filter"></i>Filter</a></li></ul>';var _topic='<div class="btn-group"><div class="topic"><div class="title">'+_cog+'<a href="#view-'+data.id+'-'+data.title+'-1" data-id="'+data.id+'" data-author='+data.author+' class="link '+cls+'">'+data.title+'</a></div></div><div class="btn-group pull-right">';_topic+='<a class="btn btn-mini dropdown-toggle spage" data-toggle="dropdown" href="#">';if(data.total_page>1)
_topic+='P.1 ~ '+data.total_page+' ';else
_topic+='P.1 ';_topic+='<span class="caret"></span>';_topic+='</a>';_topic+='<ul class="dropdown-menu dropdown-menu-page">';_topic+='<li><a href="#" data-num="1">P.1</a></li>';if(data.total_page>1)
_topic+='<li><a href="#" data-num="'+data.total_page+'">P.'+data.total_page+'</a></li>';_topic+='<li class="divider"></li>';_topic+='<li class="go-page"><div class="input-append"><input class="page-num" size="16" type="text"><button class="btn" type="button">Go!</button></div></li>';_topic+='</ul>';_topic+='</div></div>';$('<td>').html(_topic).appendTo($(tr));$('<td>').html('<span class="label">'+data.author+'</span>').appendTo($(tr));$('<td>').html('<span title="'+data.timeago+'">'+data.time+'</span>').appendTo($(tr));$('<td>').html(data.replies).appendTo($(tr));var cls='';if(parseInt(data.score)<0){cls='negative';}else if(parseInt(data.score)>0){cls='positive';}
data.score='<span class="'+cls+'">'+data.score+'<span>';$('<td>').html(data.score).appendTo($(tr));$($(tr).find("a.spage").parent()).find('.dropdown-menu-page').find('a').click(function(){self.view({id:data.id,title:data.title,author:data.author,page:$(this).attr('data-num')});});$(tr).appendTo($("#topic_table")).delay(j*200).fadeIn(300);j++;});$("a.spage").click(function(){var num=$($(this).parent()).find('.dropdown-menu-page').find('.page-num');console.log('a.spage','click',$(num));setTimeout(function(){$(num).focus();},500);});$(".tcog-link").click(function(){window.open(self.buildUrl(self.server,'view',self.channel,1,$(this).attr('data-id')));});$(".tcog-bookmark").click(function(){self.noty({text:'Function is not available',layout:self.settings.noty,type:'error',timeout:3000});return false;});$(".tcog-filter").click(function(){self.noty({text:'Function is not available',layout:self.settings.noty,type:'error',timeout:3000});return false;});$("a.link").click(function(){var el=$(this);$(el).removeClass('unread').addClass('read');self.setread({id:$(el).attr('data-id'),title:$(el).text(),time:new Date().getTime()});self.setHash('#hash-view-'+$(el).attr('data-id')+'-1');$(window).scrollTo(0,500,{onAfter:function(){self.view({id:$(el).attr('data-id'),title:$(el).text(),author:$(el).attr('data-author'),page:1});}});});}
$("#reload").attr('src','img/reload.gif');self.noty({text:self.channel_list[_data.channel]+' P.'+_data.page+'<br />Load success <img src="faces/smile.gif">',layout:self.settings.noty,type:'success',timeout:3000});}else{console.log('Server '+self.server+' Load topic fail, topic code not found',this,status);$("#reload").attr('src','img/reload.gif');var _text=self.channel_list[_data.channel]+' P.'+_data.page+'<br />Load fail <img src="faces/frown.gif">';console.warn(response);if(response.match(/請先登入/)){_text+='請先登入';}
self.noty({text:_text,layout:self.settings.noty,type:'error',timeout:false});}},error:function(xhr,status,thrown){console.log('HKGCore.topic() AJAX Error',xhr);$("#reload").attr('src','img/reload.gif');$("#tab_loading").hide();var _text='Load fail, server '+self.server+' no reponse / timeout.<br />Please try again later.';if(xhr.status!=0&&xhr.responseText.match(/maintenance/i)){_text+='<br />網站維護中，請稍後再試。<img src="faces/fuck.gif">';}else{_text+=' <img src="faces/frown.gif">';}
self.noty({text:_text,layout:self.settings.noty,type:'error',timeout:false});}});},view:function(data){var self=this;if(isUndefined(data.page)||data.page==null||data.page==0){data.page=1;}
console.log('view data',data);$("#tab_topic").slideUp(500);var _id='view_'+data.id;var _title=data.title.substr(0,30);var dropdown=$("#tabs").find('li.dropdown').find('a.dropdown-toggle');var dropdown_menu=$("#tabs").find('li.dropdown').find('ul.dropdown-menu');if($("#"+_id).length!=0){var current_page=$("#"+_id).attr('data-current');if($("#"+_id).find('div#'+_id+'_list_'+data.page).length!=0){var toolbar=$("#"+_id).find('.btn-toolbar');$("#"+_id).find('.cpage').html('P.'+data.page);$("#"+_id).find('.large_loading').hide();$("#"+_id).find('div#'+_id+'_list_'+data.page).fadeIn();$("#"+_id).attr('data-current',data.page);self.bindToolbar({'toolbar':$(toolbar),'id':_id,'vid':data.id,'title':data.title,'author':data.author,'page':data.page,'total_page':$("#"+_id).attr('data-total-page'),'url':self.buildUrl(self.server,'view',self.channel,data.page,data.id)});return;}}
if($(dropdown_menu).find("li[data-id='"+_id+"']").length==0){var li=$('<li class="tab" data-id="'+_id+'"><a href="" title="'+data.title+'">'+_title+'</a><button class="close">×</button></li>');$(li).click(function(){if(!$("#tab_topic").is(":hidden"))
$("#tab_topic").slideUp(500);$("div.thread").hide();$("#"+$(this).attr('data-id')).fadeIn();$(dropdown).find('span').html($(this).text());$("#tabs").find('li.dropdown').removeClass('open');self.current.type='view';return false;});$(li).find('button.close').click(function(){console.log('button.close');self.closeView(_id);return false;});$(li).appendTo($(dropdown_menu));}
$(dropdown_menu).find('li.empty').hide();self.setHeadTitle(_title,true);$("#topic_title").attr('title',data.title).html(_title);if($("#"+_id).length==0){$('<div id="'+_id+'" class="thread" data-title="'+data.title+'"data-current="'+data.page+'" data-total-page="1" data-replies="0"><div class="large_loading"><img src="img/large_loading.gif"></div></div>').appendTo($("div.main-body"));}
if(self.settings.cache){}
var _url=self.buildUrl(self.server,'view',self.channel,data.page,data.id);console.log('request a page',_url);self.xhr=$.ajax({url:_url,timeout:(self.settings.timeout*1000),beforeSend:function(){self.loading(_id,true);},success:function(response){self.loading(_id,false);console.log('view() ajax success hash',window.location.hash);self.setHash('#view-'+data.id+'-'+data.title+'-'+data.page);var vdata={id:data.id,title:'',tag:[],score:[0,0],list:[],page:data.page,author:data.author};var html=removeScript(response);var rows=$(html).find('div#ctl00_ContentPlaceHolder1_view_form').find('table.repliers');vdata.total_page=$($($(html).find('select[name=page]').first()).find('option').last()).val();var index=(data.page==1)?2:0;vdata.replies=$.trim($($(html).find('div#ctl00_ContentPlaceHolder1_view_form').find('table').get(index)).find("td > strong").text());var type_links=$(html).find("a[href$='type="+self.channel+"']");var prev_channel=$($(type_links).get(0)).prev();if($(prev_channel).length!=0&&$(prev_channel).attr('href').match(/topics/i)){self.setBreadcrumb('add',$(prev_channel).text());}
$(rows).each(function(i,row){var thread=$(row).find('tr[id*=Thread]');if($(row).find('td.repliers_header').length!=0){vdata.title=$.trim($($(row).find('td.repliers_header').get(1)).text());}
if($(thread).length!=0){var no=(data.page==1)?1:25*(data.page-1);var tdata={};tdata.username=$(thread).attr('username');tdata.userid=$(thread).attr('userid');tdata.no=(parseInt($(thread).attr('id').replace("Thread_No",""))+no);if(tdata.no==1){if($(thread).find('span.forum_taglabel').length!=0){$(thread).find('span.forum_taglabel').find('a').each(function(){vdata.tag.push($(this).text());});}
var score=[];score[0]=$(thread).find("div#DivMarkThread").find('span').first().text();if(score[0]=="")
score[0]=0;score[1]=$(thread).find("div#DivMarkThread").find('span').last().text();if(score[1]=="")
score[1]=0;vdata.score=[score[0],score[1]];}
if($(thread).find('.repliers_left').length!=0){var detail=$(thread).find('.repliers_left').find('a[href*=javascript]');tdata.sex='M';if($(detail).attr('style').match(/\#FF0066/g)){tdata.sex='F';}}
if($(thread).find('table.repliers_right').length!=0){var content=$(thread).find('table.repliers_right').find('td').get(0);if($(content).find("img[src='圖片網址']").length!=0){$(content).find("img[src='圖片網址']").parent('a').attr('href','#').removeAttr('target');$('<span>圖片網址?</span>').insertAfter($(content).find("img[src='圖片網址']"));$(content).find("img[src='圖片網址']").remove();}
tdata.content=$(content).html().toString().replace('<br><br><br>',"");var bottom=$(thread).find('table.repliers_right').find('td').last();var time=$($(bottom).find('span').last()).text();times=time.split(" ");if(time.match(/(AM|PM)/i)){var month=times[0].substr(0,times[0].indexOf("/"));var day=times[0].substr(times[0].indexOf("/")+1,times[0].lastIndexOf("/")-times[0].indexOf("/")-1);}else{var day=times[0].substr(0,times[0].indexOf("/"));var month=times[0].substr(times[0].indexOf("/")+1,times[0].lastIndexOf("/")-times[0].indexOf("/")-1);times[2]='';}
var year=times[0].substr(times[0].lastIndexOf("/")+1,4);time=year+'-'+month+'-'+day+' '+times[1]+' '+times[2];console.warn('date time',time);tdata.time=$.trim(time);tdata.timeago=$.timeago(new Date(time));}
vdata.list.push(tdata);}});console.log('parse view html data',vdata);var cid='view_'+data.id;var cdata=self.getCache(cid,true);if(cdata==null){self.setCache(cid,[{id:vdata.id,title:vdata.title,author:vdata.author}],true)}
self.buildView(_id,vdata);self.noty({text:data.title+'<br />P.'+data.page+'<br />Load success <img src="faces/smile.gif">',layout:self.settings.noty,type:'success',timeout:3000});},error:function(xhr){self.loading(_id,false);console.log('Load view fail',xhr);var _text=data.title+'<br />P.'+data.page+'<br />Load fail';self.closeView(_id);if(xhr.status!=0&&xhr.responseText.match(/maintenance/i)){_text+='<br />網站維護中，請稍後再試。<img src="faces/fuck.gif">';}else{_text+=' <img src="faces/frown.gif">';}
self.noty({text:_text,layout:self.settings.noty,type:'error',timeout:false});}});},buildView:function(id,data){console.log('build view',id,data);var self=this;var container=$('<div class="list" id="'+id+'_list_'+data.page+'"></div>').attr('data-page',data.total_page).appendTo($('#'+id));if(data.list.length!=0){if($('#'+id).find('.option').length==0){var option=$('<div class="option clearfix"></div>').insertBefore($('#'+id).find('.large_loading'));var select_page='<div class="btn-group"><button class="btn dropdown-toggle cpage" data-toggle="dropdown">P.'+data.page+' <span class="caret"></span></button><ul class="dropdown-menu dropdown-menu-page"><li class="fpage" data-page="'+data.page+'"><a href="#">P.1</a></li>';if(data.page!=data.total_page)
select_page+='<li class="lpage" data-page="'+data.total_page+'"><a href="#">P.'+data.total_page+'</a></li>';select_page+='<li class="divider"></li><li class="go-page"><div class="input-append"><input class="page-num" size="16" type="text"><button class="btn gopage" type="button">Go!</button></div></li></ul></div>';var toolbar=$('<div class="btn-toolbar">'+select_page+'<div class="btn-group"><button class="btn option-bookmark" rel="tooltip" title="Bookmark"><i class="icon-bookmark"></i></button><button class="btn option-reload" rel="tooltip" title="Reload page"><i class="icon-refresh option-reload"></i></button><button class="btn option-close" rel="tooltip" title="Close"><i class="icon-remove"></i></button><button class="btn option-link" rel="tooltip" title="Go to original url"><i class="icon-share-alt"></i></button></div><div class="btn-group"><button class="btn ppage" rel="tooltip" title="Prev page"><i class="icon-circle-arrow-left"></i></button><button class="btn godown" rel="tooltip" title="Scroll down"><i class="icon-circle-arrow-down"></i></button><button class="btn npage" rel="tooltip" title="Next page"><i class="icon-circle-arrow-right"></i></button></div></div>').appendTo($(option));$('<div class="right"><span class="badge"><i class="icon-tags"></i>'+data.tag.join(' ')+'</span><span class="badge">Replies <span class="replies">'+data.replies+'</span></span></div>').appendTo($(option));$("#"+id).attr('data-replies',data.replies);}else{var toolbar=$("#"+id).find('.btn-toolbar');$("#"+id).find('.cpage').html('P.'+data.page);}
self.bindToolbar({'toolbar':$(toolbar),'id':id,'vid':data.id,'title':data.title,'author':data.author,'page':data.page,'total_page':data.total_page,'url':self.buildUrl(self.server,'view',data.channel,data.page,data.id)});var t_table=$('<table class="table table-bordered">');$.each(data.list,function(i,d){var score='',isauthor='';if(i==0&&data.page==1){score='<div class="btn-group"><button class="btn"><img src="faces/ThumbUp.gif">'+data.score[0]+'</a></button><button class="btn"><img src="faces/ThumbDown.gif">'+data.score[1]+'</a></button></div>';}
var mics='<div class="left">'+score+'</div>';mics+='<div class="right" rel="tooltip" title="'+d.time+'"><span class="badge badge-inverse"><i class="icon-time icon-white"></i> '+d.timeago+'</span></div>';var content='<div class="box"><div class="num" rel="tooltip left" title="Left click scroll down<br />Right click scroll up" data-index="'+i+'"><span class="badge badge-important">#'+d.no+'</span></div>';content+='<div class="content">'+self.convertContent(d.content)+'</div>';content+='<div class="mics clearfix">'+mics+'</div>';content+='</div></div>';if(d.username==data.author){isauthor='<div title="樓主" class="icon icon-user"></div>';}
$('<tr><td><div class="author sex_'+d.sex+'">'+d.username+'</div>'+isauthor+'</td><td>'+content+'</td></tr').appendTo($(t_table));});$(t_table).appendTo($(container));var page_box=$('<div class="page-box"><ul class="pager"><li class="previous"><a href="#">Previous</a></li><li class="top"><a href="#" id="go_top">P.'+data.page+' / '+data.total_page+'</a></li><li class="next"><a href="#">Next</a></li></ul></div>').appendTo($(container));$(page_box).find('.next').click(function(){data.vid=data.id;data.id=id;self.goPage('next',data);return false;});$(page_box).find('.previous').click(function(){data.vid=data.id;data.id=id;self.goPage('prev',data);return false;});$(page_box).find('.top').click(function(){$(window).scrollTo(0,500);return false;});$(t_table).find('.content').find('img').load(function(){if($(this).width()>500){$(this).css({width:500});}});$(t_table).find('.content').find('.img-zoom').each(function(i,el){$(el).click(function(){var src=$(el).parent().attr('href');var img=$('<img src="'+src+'" />');var imgid='img_'+i;console.log('img src',src);var m=buildModal({id:imgid,header:'<a href="'+src+'" target="_blank">'+src+'</a>',body:'<div class="tcenter"><img src="img/loading.gif"></div>'});$(m).modal();$(img).load(function(){console.log('img load',$(img).width());$("#"+imgid).find('img').attr('src',src);});return false;});});if(data.page!=1){console.log('update total, replies',$("#"+id).attr('data-replies'),data.replies);if($("#"+id).attr('data-replies')!=data.replies){$("#"+id).attr('data-replies',data.replies);$("#"+id).find('.option').find('.replies').html(data.replies);}}
$("#"+id).attr('data-total-page',data.total_page);$("#reload").attr('src','img/reload.gif');$('#'+id).find(".large_loading").hide();$('#'+id).find(".num").click(function(){var index=parseInt($(this).attr('data-index'))+1;var y=$($('#'+id).find('.content').get(index)).offset().top;console.log('scroll to content',index,$('#'+id).find('.content').get(index),y);$(window).scrollTo({top:y-100,left:0},500);}).contextmenu(function(){var index=parseInt($(this).attr('data-index'))-1;var y=$($('#'+id).find('.content').get(index)).offset().top;console.log('scroll to content',index,$('#'+id).find('.content').get(index),y);if(index>=0)
$(window).scrollTo({top:y-100,left:0},500);return false;});$('#'+id).find("[rel*='tooltip']").each(function(i,el){var options;var m=$(el).attr('rel').match(/(top|bottom|left|right)/i);if(m){options={placement:m[1],};$(el).click(function(){$(el).tooltip('hide');});}
$(el).tooltip(options);});}else{console.log('data.list is empty',data);self.noty({text:'Build view layout fail',layout:self.settings.noty,type:'error'});}},closeView:function(id){var self=this;console.log('closeView',id);var dropdown=$("#tabs").find('li.dropdown').find('a.dropdown-toggle');var dropdown_menu=$("#tabs").find('li.dropdown').find('ul.dropdown-menu');self.current.type='topic';self.setHash('');self.setHeadTitle($("title").data('original'));self.setBreadcrumb('remove');$("#bottom_toolbar").find('button.hide').hide();if(id=='all'){$(dropdown).find('span').attr('title','').html('');$(dropdown_menu).find('li.tab').remove();$(dropdown_menu).find('li.empty').show();$(".thread").remove();$("#tab_topic").slideDown(1500);self.noty({text:'All tabs close complete <img src="faces/angel.gif">',layout:self.settings.noty,type:'success',timeout:3000});}else{$("#"+id).fadeOut(1000,function(){var text=$("li[data-id='"+id+"']").find('a').attr('title');$("li[data-id='"+id+"']").remove();$(dropdown).find('span').attr('title','').html('');if($(dropdown_menu).find('li').length==1){$(dropdown_menu).find('li.empty').show();$("body").trigger('click');}
$("#tab_topic").slideDown(1500);if($("#tab_topic").find('tr').length==1){self.topic();}
self.noty({text:text+'<br />Close complete <img src="faces/angel.gif">',layout:self.settings.noty,type:'success',timeout:3000});});}},bindToolbar:function(obj){var self=this;console.log('bindToolbar',obj);self.current={type:'view',id:obj.id,vid:obj.vid,title:obj.title,page:obj.page,cache:0};$(obj.toolbar).find(".cpage").click(function(){console.log('click toolbar page dropdown',$(obj.toolbar).find('.dropdown-menu-page').find('.page-num').length);setTimeout(function(){var page_num=$(obj.toolbar).find('.dropdown-menu-page').find('.page-num')
$(page_num).focus();$(page_num).keypress(function(e){console.log('page_num keypress',e.keyCode);if(e.keyCode==13){obj.num=parseInt($(page_num).val());if(obj.num>0&&obj.num<=obj.total_page){$(obj.toolbar).find('.gopage').trigger('click');}}});},500);});$(obj.toolbar).find('.option-bookmark').unbind('click').click(function(){self.noty({text:'Function is not available',layout:self.settings.noty,type:'error',timeout:3000});});$(obj.toolbar).find('.option-reload').click(function(){self.reload();});$(obj.toolbar).find('.option-close').unbind('click').click(function(){self.closeView(obj.id);});$(obj.toolbar).find('.option-link').unbind('click').one('click',function(){window.open(obj.url);});$(obj.toolbar).find('.ppage').unbind('click').removeClass('disabled').addClass((obj.page==1)?'disabled':'').click(function(){self.goPage('prev',obj);return false;});$(obj.toolbar).find('.godown').click(function(){$(window).scrollTo($('.main-footer'),500);});$(obj.toolbar).find('.npage').unbind('click').removeClass('disabled').addClass((obj.page==obj.total_page)?'disabled':'').click(function(){self.goPage('next',obj);});$(obj.toolbar).find('.fpage').unbind('click').click(function(){console.log('jump to first page',$(this).attr('data-page'));var fpage=$(this).attr('data-page');$("#"+obj.id).find('.list').hide();var lpage=$(this).attr('data-page');$(window).scrollTo(0,500,function(){$("#"+obj.id).find('.large_loading').show();self.view({id:obj.vid,title:obj.title,page:fpage,cache:0});});return false;});$(obj.toolbar).find('.lpage').unbind('click').click(function(){console.log('jump to last page',$(this).attr('data-page'));$("#"+obj.id).find('.list').hide();var lpage=$(this).attr('data-page');$(window).scrollTo(0,500,function(){$("#"+obj.id).find('.large_loading').show();self.view({id:obj.vid,title:obj.title,page:lpage,cache:0});});return false;});$(obj.toolbar).find('.gopage').unbind('click').click(function(){obj.num=$(obj.toolbar).find('.page-num').val();self.goPage('num',obj);});},goPage:function(type,data){var self=this;console.log('gopage',data);if(type=='next'){if(data.page!=data.total_page){$("#"+data.id).find('.list').hide();$(window).scrollTo(0,500,function(){$("#"+data.id).find('.large_loading').show();self.view({id:data.vid,title:data.title,author:data.author,page:(data.page+1),cache:0});});}else{self.noty({text:'No next page'});}}else if(type=='prev'){if(data.page!=1){$("#"+data.id).find('.list').hide();$(window).scrollTo(0,500,function(){$("#"+data.id).find('.large_loading').show();self.view({id:data.vid,title:data.title,author:data.author,page:(data.page-1),cache:0});});}else{self.noty({text:'No previous page'});}}else if(type=='num'){$("#"+data.id).find('.list').hide();$(window).scrollTo(0,500,function(){$("#"+data.id).find('.large_loading').show();self.view({id:data.vid,title:data.title,author:data.author,page:data.num,cache:0});});}},buildUrl:function(server,target,channel,page,id){var url=this.url;if(target=='view'){url=url.replace('topics','view');}
if(server=='random')
this.server=this.randomServer();else
this.server=server;console.log('server',this.server,'channel',channel);if(channel!=this.channel){$("#current_channel").html(this.channel_list[channel]);}
url=url.replace(/forum([0-9]+)/,'forum'+this.server);url=url.replace(/type\=([a-zA-Z]+)/,'type='+channel);if(!isUndefined(id))
url+='&message='+id;if(!isUndefined(page))
url+='&page='+page;if(!this.settings.sensor)
url+='&sensormode=N';return url;},randomServer:function(){return Math.floor((Math.random()*11)+1);},timeFormat:function(time){var times=time.split(" ");if(time.match(/(AM|PM)/i)){var month=times[0].substr(0,times[0].indexOf("/"));var day=times[0].substr(times[0].indexOf("/")+1,times[0].lastIndexOf("/")-times[0].indexOf("/")-1);}else{var day=times[0].substr(0,times[0].indexOf("/"));var month=times[0].substr(times[0].indexOf("/")+1,times[0].lastIndexOf("/")-times[0].indexOf("/")-1);times[2]='';}
var year=times[0].substr(times[0].lastIndexOf("/")+1,4);time=year+'-'+month+'-'+day+' '+times[1]+' '+times[2];time=$.trim(time);var data={'time':time,'timeago':$.timeago(new Date(time))};return data;},noty:function(option){if($.noty){var options={text:'',layout:'bottomRight',type:'information',timeout:3000};$.extend(options,option);return noty(options);}else{$('<div id="noty">'+option.text+'</div>').css({position:'fixed',bottom:0,right:0,border:'1px solid #CCC',padding:'5px',background:'#FFFFFF'}).appendTo($("body"));}},loading:function(id,show){var self=this;console.log('loading()',id,show);if(show){$("#reload").attr('src','img/loading.gif');$("#"+id).find('.large_loading').show();}else{$("#reload").attr('src','img/reload.gif');$("#"+id).find('.large_loading').hide();}},reload:function(){var self=this;console.log('reload()',self.current);if(self.current.type=='topic'){console.log('current server',self.server);self.xhr.abort();console.log('xhr.abort()');self.settings.server=self.server;self.topic(self.current);}else{var obj=self.current;$("#"+obj.id).find('.option').remove();$("#"+obj.id+"_list_"+obj.page).remove();$("#"+obj.id).find('.large_loading').show();self.view({id:obj.vid,title:obj.title,author:obj.author,page:obj.page,cache:0})}},close:function(){if(this.current.type=='view'){this.closeView(this.current.id);}},backTopic:function(){$("div.thread").fadeOut();$("#tabs").find('li.dropdown').find('a.dropdown-toggle').find('span').html('');this.setHeadTitle(this.channel_list[this.channel],true);this.setHash('');this.setBreadcrumb('remove');if($("#tab_topic").find('tr').length==1){this.topic();}
$("#tab_topic").slideDown(1500);$("#bottom_toolbar").find('button.hide').hide();this.current.type='topic';},convertContent:function(content){var c=$('<div>'+content+'</div>');var link=[];$(c).find("a").each(function(i,el){var text='',href='#';if($(el).find('img').length!=0){$(el).find('img').replaceWith('[IMG]'+$(el).find('img').attr('src')+'[/IMG]');href=$(el).find('img').attr('src');text=$(el).text();$(el).replaceWith('[LINK_'+i+']');}else{href=$(el).attr('href');text=$(el).text();$(el).replaceWith('[LINK_'+i+']');}
link.push({'href':href,'text':text});});content=$(c).html().linkify(' target="_blank"');if(link.length!=0){$.each(link,function(i,d){var attr=(d.href!='#')?' target="_blank"':'';console.log(d);if(!isUndefined(d.href)&&d.href.match(/(png|jpg|gif)/i)){d.text+='<span class="icon-zoom-in vmiddle img-zoom"></span>';}
var url='<a href="'+d.href+'"'+attr+'>'+d.text+'</a>';content=content.replace('[LINK_'+i+']',url);});}
content=content.replace(/\[IMG\](.*?)\[\/IMG\]/g,'<a href="$1" target="_blank"><img src="$1"></a>');content=content.replace(/\[(\w+)[^w]*?](.*?)\[\/\1]/g,'$2');return content;},isread:function(id){if($.cookie('isread')){var data=JSON.parse($.cookie('isread'));$.each(data,function(){if(this.id==id){return this;}});}
return false;},setread:function(data){var tmp=[];var exist=false;if($.cookie('isread')){tmp=JSON.parse($.cookie('isread'));$.each(tmp,function(){if(this.id==data.id){exist=true;}});}
if(!exist){tmp.push(data);$.cookie('isread',JSON.stringify(tmp),{path:'/'});}
return true;},setCache:function(name,value,stringify){if(stringify)
value=JSON.stringify(value);localStorage.setItem(name,value);return true;},getCache:function(name,parse){var value=localStorage.getItem(name);if(parse)
value=JSON.parse(value);console.log('getCache()',name,value);return value;},setHeadTitle:function(text,append){console.log('setHeadTitle()',text,append);if(typeof(append)!="undefined"){text+=' - '+$("title").data('original');}
if(text=="undefined")
text=this.channelName(this.settings.channel);$("title").html(text);},channelName:function(channel){console.log('channelName()',channel,this.channel_list[channel]);return!isUndefined(this.channel_list[channel])?this.channel_list[channel]:'';},keyboardControl:function(){var self=this;console.log('keyboardControl()');$(document).unbind('keydown').bind('keydown',function(e){if(e.which===116){e.preventDefault();e.originalEvent.keyCode=0;console.log('F5 blocked',new Date().getTime(),self.current);if(self.current.type=='topic'){self.topic();}
return false;}else if(e.which===82&&e.ctrlKey){e.preventDefault();e.originalEvent.keyCode=0;console.log('ctrl + F5 blocked',new Date().getTime(),self.current);return false;}});},setHash:function(hash){console.log('setHash()',hash);this.hash=hash;document.location.hash=hash;},setBreadcrumb:function(type,text){if(type=='add'){if($("#breadcrumb").find("li:contains('"+text+"')").length==0)
$('<li> <span class="divider">/</span> '+text+'</li>').appendTo($("#breadcrumb"));}else{if($("#breadcrumb").find('li').length>2){$("#breadcrumb").find('li:gt(1)').remove();}}}}